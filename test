private async Task<SizeScaleResult> ComputeSizeScaleAsync(RecalcOrigin origin, int layoutFormat, CancellationToken ct)
{
    // Snapshot
    double inputX = _pageSizeX;
    double inputY = _pageSizeY;
    double inputMapScale = _mapScale;
    double inputRelScale = _relScale;

    double margin = marginSz;
    double gap = gapSz;
    double legendPercent = legendAreaPercent;
    double logoHeightBase = MapLayoutConstants.logoHeight;

    // IMPORTANT: remove ct from QueuedTask.Run call; still check ct inside
    return await QueuedTask.Run(() =>
    {
        ct.ThrowIfCancellationRequested();

        var mv = MapView.Active;
        if (mv?.Map == null || mv.Extent == null)
            return new SizeScaleResult(inputX, inputY, inputMapScale, inputRelScale);

        var map = mv.Map;

        // --- Determine "feet" like you currently do (kept as-is) ---
        var srUnitLinear = map.SpatialReference?.Unit as LinearUnit;
        bool feet = srUnitLinear != null &&
                    (srUnitLinear.Name == "Foot_US" || Math.Abs(srUnitLinear.MetersPerUnit - 0.305) < 1e-6);

        double mapWidth = mv.Extent.Width;
        double mapHeight = mv.Extent.Height;
        if (mapWidth <= 0 || mapHeight <= 0)
            return new SizeScaleResult(inputX, inputY, inputMapScale, inputRelScale);

        double pageX = inputX;
        double pageY = inputY;
        double mapScale = inputMapScale;
        double relScale = inputRelScale;
        double legendXLocal = 0.0;
        double logoMarginLocal = logoHeightBase;

        double workingMargin = MapLayoutConstants.marginSz;
        double workingGap = MapLayoutConstants.gapSz;
        double workingLegendPercent = MapLayoutConstants.legendAreaPercent;

        // Ground width/height in current SR units (kept names)
        double groundWidth = mv.Extent.Width;
        double groundHeight = mv.Extent.Height;
        if (groundWidth <= 0 || groundHeight <= 0)
            return new SizeScaleResult(inputX, inputY, inputMapScale, inputRelScale);

        // ---------------- FIXED UNIT PIPELINE ----------------
        // FactoryCode (e.g., 9001, 9002, 9003, 9102) drives page unit choice and getESRIUnit2Str logic
        int mapUnitFc = map.SpatialReference?.Unit?.FactoryCode ?? 0;

        // UnitTypeCode drives DistanceConversion and SrUnitByRegion
        int unitTypeCode;
        var srUnit = map.SpatialReference?.Unit;

        if (srUnit is AngularUnit)
            unitTypeCode = (int)UnitTypeCode.Degrees;
        else if (srUnit is LinearUnit lu)
            unitTypeCode = (int)lu.UnitType; // Feet, FeetUS, Meters...
        else
            unitTypeCode = (int)UnitTypeCode.Unknown;

        // expected SR unit (per region) expects UnitTypeCode
        int expectedSrUnit = MiscUtil.SrUnitByRegion(unitTypeCode);

        // page unit expects FactoryCode
        int expectedPageUnit = MiscUtil.GetPageUnitByRegion(mapUnitFc);

        // Convert ground dimension to expected SR units (UnitTypeCode -> expectedSrUnit)
        double groundWidthExp = MiscUtil.RoundToDecimalD(
            MiscUtil.DistanceConversion(groundWidth, unitTypeCode, expectedSrUnit));

        double groundHeightExp = MiscUtil.RoundToDecimalD(
            MiscUtil.DistanceConversion(groundHeight, unitTypeCode, expectedSrUnit));

        // Convert expected SR units into “page-friendly” units (cm/in)
        double toPageFactor = 1.0;
        if (expectedPageUnit == (int)ArcGIS.Core.CIM.esriUnits.esriCentimeters) toPageFactor = 100.0;
        else if (expectedPageUnit == (int)ArcGIS.Core.CIM.esriUnits.esriInches) toPageFactor = 12.0;

        double groundWidthPage = groundWidthExp * toPageFactor;
        double groundHeightPage = groundHeightExp * toPageFactor;

        // Ratio (same as before)
        double ratio = groundWidth / groundHeight;
        // ------------------------------------------------------

        void AdjustOffsets(double px, double py)
        {
            double larger = Math.Max(px, py);
            double pageRatioLocal = MiscUtil.RoundToDecimalD(larger / 11.0);
            double coeff = 0.0;

            if (pageRatioLocal >= 7.0) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 7.5);
            else if (pageRatioLocal >= 6.0) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 6.5);
            else if (pageRatioLocal >= 5.0) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 5.5);
            else if (pageRatioLocal >= 4.0) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 4.5);
            else if (pageRatioLocal >= 3.0) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 3.5);
            else if (pageRatioLocal >= 2.5) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 2.5);
            else if (pageRatioLocal >= 2.0) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 2.0);
            else if (pageRatioLocal >= 1.5) coeff = MiscUtil.RoundToDecimalD(MapLayoutConstants.pageCoeff * pageRatioLocal * 1.5);

            workingLegendPercent = MapLayoutConstants.legendAreaPercent;
            workingMargin = MapLayoutConstants.marginSz + MapLayoutConstants.marginSz * coeff;
            workingGap = MapLayoutConstants.gapSz + MapLayoutConstants.gapSz * coeff;

            if (pageRatioLocal < 1.0)
            {
                workingMargin = MapLayoutConstants.marginSz * 0.5;
                workingGap = MapLayoutConstants.gapSz * 0.5;
            }
        }

        void ComputeFromY()
        {
            double miny = workingMargin + workingMargin;
            double minx = workingMargin + workingMargin;
            double cx = 4.0 * workingMargin;
            double cy = (layoutFormat == 1) ? 4.0 * workingMargin : 2.0 * workingMargin;

            if (layoutFormat == 1)
            {
                double mapSizeYLocal = pageY - miny - cy - workingMargin;
                double mapSizeXLocal = mapSizeYLocal * ratio;
                pageX = (mapSizeXLocal + minx + 2.0 * workingMargin + cx) / (1 - workingLegendPercent);
                legendXLocal = pageX * workingLegendPercent + cx;
                AdjustOffsets(pageX, pageY);

                if (pageY > 11.0)
                    logoMarginLocal = (pageY / 11.0) * MapLayoutConstants.logoHeight + workingMargin;
                else
                    logoMarginLocal = MapLayoutConstants.logoHeight + workingMargin;
                cy = logoMarginLocal;

                mapSizeYLocal = pageY - miny - cy - workingMargin;
                mapSizeXLocal = mapSizeYLocal * ratio;
                pageX = (mapSizeXLocal + minx + 2.0 * workingMargin + cx) / (1 - workingLegendPercent);
                legendXLocal = pageX * workingLegendPercent + cx;
            }
            else if (layoutFormat == 2)
            {
                double mapSizeYLocal = pageY - miny - cy;
                double mapSizeXLocal = mapSizeYLocal * ratio;
                pageX = (mapSizeXLocal + minx + 2.0 * workingMargin + cx) / (1 - workingLegendPercent);
                legendXLocal = pageX * workingLegendPercent + cx;
                AdjustOffsets(pageX, pageY);

                mapSizeYLocal = pageY - miny - cy;
                mapSizeXLocal = mapSizeYLocal * ratio;
                pageX = (mapSizeXLocal + minx + 2.0 * workingMargin + cx) / (1 - workingLegendPercent);
                legendXLocal = pageX * workingLegendPercent + cx;
            }
            else if (layoutFormat == 3)
            {
                legendXLocal = 0.0;
                double mapSizeYLocal = pageY - miny - cy;
                double mapSizeXLocal = mapSizeYLocal * ratio;
                pageX = mapSizeXLocal + minx + legendXLocal + 2.0 * workingMargin;
                AdjustOffsets(pageX, pageY);

                mapSizeYLocal = pageY - miny - cy;
                mapSizeXLocal = mapSizeYLocal * ratio;
                pageX = mapSizeXLocal + minx + legendXLocal + 2.0 * workingMargin;
            }
        }

        void ComputeFromX()
        {
            double miny = workingMargin + workingMargin;
            double minx = workingMargin + workingMargin;
            double cx = 4.0 * workingMargin;
            double cy = (layoutFormat == 1) ? 4.0 * workingMargin : 2.0 * workingMargin;

            if (layoutFormat == 1)
            {
                legendXLocal = pageX * workingLegendPercent + cx;
                double mapSizeXLocal = pageX - minx - legendXLocal - 2.0 * workingMargin;
                double mapSizeYLocal = mapSizeXLocal / ratio;
                pageY = mapSizeYLocal + miny + cy + workingMargin;
                AdjustOffsets(pageX, pageY);

                if (pageY > 11.0)
                    logoMarginLocal = (pageY / 11.0) * MapLayoutConstants.logoHeight + workingMargin;
                else
                    logoMarginLocal = MapLayoutConstants.logoHeight + workingMargin;
                cy = logoMarginLocal;

                legendXLocal = pageX * workingLegendPercent + cx;
                mapSizeXLocal = pageX - minx - legendXLocal - 2.0 * workingMargin;
                mapSizeYLocal = mapSizeXLocal / ratio;
                pageY = mapSizeYLocal + miny + cy + workingMargin;
            }
            else if (layoutFormat == 2)
            {
                legendXLocal = pageX * workingLegendPercent + cx;
                double mapSizeXLocal = pageX - minx - legendXLocal - 2.0 * workingMargin;
                double mapSizeYLocal = mapSizeXLocal / ratio;
                pageY = mapSizeYLocal + miny + cy;
                AdjustOffsets(pageX, pageY);

                legendXLocal = pageX * workingLegendPercent + cx;
                mapSizeXLocal = pageX - minx - legendXLocal - 2.0 * workingMargin;
                mapSizeYLocal = mapSizeXLocal / ratio;
                pageY = mapSizeYLocal + miny + cy;
            }
            else if (layoutFormat == 3)
            {
                legendXLocal = 0.0;
                double mapSizeXLocal = pageX - minx - legendXLocal - 2.0 * workingMargin;
                double mapSizeYLocal = mapSizeXLocal / ratio;
                pageY = mapSizeYLocal + miny + cy;
                AdjustOffsets(pageX, pageY);

                mapSizeXLocal = pageX - minx - legendXLocal - 2.0 * workingMargin;
                mapSizeYLocal = mapSizeXLocal / ratio;
                pageY = mapSizeYLocal + miny + cy;
            }
        }

        void ComputeFromScale(bool isRatioPath)
        {
            if (isRatioPath)
            {
                mapScale = ClampPositive(mapScale);
                relScale = ClampPositive(feet ? mapScale / 12.0 : mapScale / 100.0);
            }
            else
            {
                relScale = ClampPositive(relScale);
                mapScale = ClampPositive(feet ? relScale * 12.0 : relScale * 100.0);
            }

            // Use converted ground dims in “page units” for frame sizing (legacy behavior)
            double mapFrameX = groundWidthPage / mapScale;
            double mapFrameY = groundHeightPage / mapScale;

            double miny = workingMargin + workingMargin;
            double minx = workingMargin + workingMargin;
            double cx = 4.0 * workingMargin;
            double cy = 2.0 * workingMargin;

            if (layoutFormat == 2)
            {
                pageY = mapFrameY + miny + cy;
                legendXLocal = mapFrameX * workingLegendPercent + cx;
                pageX = minx + mapFrameX + legendXLocal + 3.0 * workingMargin;
                AdjustOffsets(pageX, pageY);

                pageY = mapFrameY + miny + cy;
                legendXLocal = mapFrameX * workingLegendPercent + cx;
                pageX = minx + mapFrameX + legendXLocal + 3.0 * workingMargin;
            }
            else if (layoutFormat == 1)
            {
                cy = 4.0 * workingMargin;
                pageY = mapFrameY + miny + cy + workingMargin;
                legendXLocal = mapFrameX * workingLegendPercent + cx;
                pageX = minx + mapFrameX + legendXLocal + 3.0 * workingMargin;
                AdjustOffsets(pageX, pageY);

                if (pageY > 11.0)
                    logoMarginLocal = (pageY / 11.0) * MapLayoutConstants.logoHeight + workingMargin;
                else
                    logoMarginLocal = MapLayoutConstants.logoHeight + workingMargin;
                cy = logoMarginLocal;

                pageY = mapFrameY + miny + cy + workingMargin;
                legendXLocal = mapFrameX * workingLegendPercent + cx;
                pageX = minx + mapFrameX + legendXLocal + 3.0 * workingMargin;
            }
            else if (layoutFormat == 3)
            {
                legendXLocal = 0.0;
                cx = 4 * workingMargin;
                cy = 4 * workingMargin;
                pageY = mapFrameY + cy;
                pageX = mapFrameX + cx;
                AdjustOffsets(pageX, pageY);

                pageY = mapFrameY + cy;
                pageX = mapFrameX + cx;
            }
        }

        switch (origin)
        {
            case RecalcOrigin.PageY:
                ComputeFromY();
                mapScale = ClampPositive(mv.Camera.Scale);
                relScale = ClampPositive(feet ? mapScale / 12.0 : mapScale / 100.0);
                break;

            case RecalcOrigin.PageX:
                ComputeFromX();
                mapScale = ClampPositive(mv.Camera.Scale);
                relScale = ClampPositive(feet ? mapScale / 12.0 : mapScale / 100.0);
                break;

            case RecalcOrigin.RatioScale:
                ComputeFromScale(isRatioPath: true);
                break;

            case RecalcOrigin.RelativeScale:
                ComputeFromScale(isRatioPath: false);
                break;

            case RecalcOrigin.FormatChange:
                if (_lastUserEditOrigin == RecalcOrigin.PageX)
                {
                    ComputeFromX();
                    mapScale = ClampPositive(mv.Camera.Scale);
                    relScale = ClampPositive(feet ? mapScale / 12.0 : mapScale / 100.0);
                }
                else if (_lastUserEditOrigin == RecalcOrigin.PageY)
                {
                    ComputeFromY();
                    mapScale = ClampPositive(mv.Camera.Scale);
                    relScale = ClampPositive(feet ? mapScale / 12.0 : mapScale / 100.0);
                }
                else
                {
                    ComputeFromScale(isRatioPath: true);
                }

                // NOTE: this overwrites user-entered scale on format change; kept as-is
                mapScale = ClampPositive(mv.Camera.Scale);
                relScale = ClampPositive(feet ? mapScale / 12.0 : mapScale / 100.0);
                break;

            default:
                return new SizeScaleResult(inputX, inputY, inputMapScale, inputRelScale);
        }

        pageX = ClampPositive(MiscUtil.RoundToDecimalD(pageX));
        pageY = ClampPositive(MiscUtil.RoundToDecimalD(pageY));
        mapScale = ClampPositive(MiscUtil.RoundToDecimalD(mapScale));
        relScale = ClampPositive(MiscUtil.RoundToDecimalD(relScale));

        return new SizeScaleResult(pageX, pageY, mapScale, relScale);
    });
}
